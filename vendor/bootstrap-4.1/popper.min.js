<?php
require_once("cnx/swgc-mysql.php");
require_once("cls/cls-sistema.php");

//ini_set('display_errors', 1);
//ini_set('display_startup_errors', 1);
//error_reporting(E_ALL);

$clSistema = new clSis();
session_start();

$bAll = $_SESSION['bAll'];
$bDelete = $_SESSION['bDelete'];

$select = "SELECT be.*, cc.tNombres, cc.tApellidos, cc.bLibre FROM BitEventos be INNER JOIN CatClientes cc ON cc.eCodCliente = be.eCodCliente WHERE be.eCodEvento = ".$_GET['v1'];
//echo $select;
$rsPublicacion = mysql_query($select);
$rPublicacion = mysql_fetch_array($rsPublicacion);

//clientes
$select = "	SELECT 
					cc.*, 
		
					su.tNombre as promotor
				FROM
					CatClientes cc
				
				LEFT JOIN SisUsuarios su ON su.eCodUsuario = cc.eCodUsuario".
		($bAll ? "" : " WHERE cc.eCodUsuario = ".$_SESSION['sessionAdmin']['eCodUsuario']).
				" ORDER BY cc.eCodCliente ASC";
$rsClientes = mysql_query($select);

$horas = array();

$horas[] = array('00:00','00:00 - 05:00');
$horas[] = array('00:30','00:30 - 05:30');
$horas[] = array('01:00','01:00 - 06:00');
$horas[] = array('01:30','01:30 - 06:30');
$horas[] = array('02:00','02:00 - 07:00');
$horas[] = array('02:30','02:30 - 07:30');
$horas[] = array('03:00','03:00 - 08:00');
$horas[] = array('03:30','03:30 - 08:30');
$horas[] = array('04:00','04:00 - 09:00');
$horas[] = array('04:30','04:30 - 09:30');
$horas[] = array('05:00','05:00 - 10:00');
$horas[] = array('05:30','05:30 - 10:30');
$horas[] = array('06:00','06:00 - 11:00');
$horas[] = array('06:30','06:30 - 11:30');
$horas[] = array('07:00','07:00 - 12:00');
$horas[] = array('07:30','07:30 - 12:30');
$horas[] = array('08:00','08:00 - 13:00');
$horas[] = array('08:30','08:30 - 13:30');
$horas[] = array('09:00','09:00 - 14:00');
$horas[] = array('09:30','09:30 - 14:30');
$horas[] = array('10:00','10:00 - 15:00');
$horas[] = array('10:30','10:30 - 15:30');
$horas[] = array('11:00','11:00 - 16:00');
$horas[] = array('11:30','11:30 - 16:30');
$horas[] = array('12:00','12:00 - 17:00');
$horas[] = array('12:30','12:30 - 17:30');
$horas[] = array('13:00','13:00 - 18:00');
$horas[] = array('13:30','13:30 - 18:30');
$horas[] = array('14:00','14:00 - 19:00');
$horas[] = array('14:30','14:30 - 19:30');
$horas[] = array('15:00','15:00 - 20:00');
$horas[] = array('15:30','15:30 - 20:30');
$horas[] = array('16:00','16:00 - 21:00');
$horas[] = array('16:30','16:30 - 21:30');
$horas[] = array('17:00','17:00 - 22:00');
$horas[] = array('17:30','17:30 - 22:30');
$horas[] = array('18:00','18:00 - 23:00');
$horas[] = array('18:30','18:30 - 23:30');
$horas[] = array('19:00','19:00 - 00:00');
$horas[] = array('19:30','19:30 - 00:30');
$horas[] = array('20:00','20:00 - 01:00');
$horas[] = array('20:30','20:30 - 01:30');
$horas[] = array('21:00','21:00 - 02:00');
$horas[] = array('21:30','21:30 - 02:30');
$horas[] = array('22:00','22:00 - 03:00');
$horas[] = array('22:30','22:30 - 03:30');
$horas[] = array('23:00','23:00 - 04:00');
$horas[] = array('23:30','23:30 - 04:30');
?>

<div class="row">
    <div class="col-lg-12">
    <form id="datos" name="datos" action="<?=$_SERVER['REQUEST_URI']?>" method="post" enctype="multipart/form-data">
        <input type="hidden" name="eCodEvento" id="eCodEvento" value="<?=$_GET['v1']?>">
        <input type="hidden" name="nvaFecha" id="nvaFecha">
        <input type="hidden" name="eAccion" id="eAccion">
                            <div class="col-lg-12">
								
                                
                                
                                
                                <div class="col-lg-12" id="cot1" >
                                    
                                    <div class="card-body card-block">
                                        <!--campos-->
                                        
           <div class="form-group">
              <label> Cliente</label> 
               <input type="hidden" name="eCodCliente" id="eCodCliente" value="<?=$rPublicacion{'eCodCliente'};?>"> 
               <input type="hidden" name="bLibre" id="bLibre" value="<?=($rPublicacion{'bLibre'} ? 1 : 2);?>"> 
               <input type="text" class="form-control" id="tCliente" <?=(($_GET['v1']) ? 'readonly="readonly"' : '' )?> value="<?=(($rPublicacion{'eCodCliente'}) ? $rPublicacion{'tNombres'} . ' '.$rPublicacion{'tApellidos'} : '');?>" placeholder="Cliente" onkeyup="buscarClientes()" onkeypress="buscarClientes()"> 
               <small>Buscar y seleccionar el cliente de la lista</small>
               </div>
                                        
        
           
           <div class="form-group">
              <label>I.V.A ?<input type="checkbox" class="form-control" name="bIVA" id="bIVA" value="1" <?=$rPublicacion{'bIVA'} ? "checked" : ""?> onclick="calcular();"></label>
           </div>
           <div class="form-group" style="display:none;">
              <label>Incluir Hora Extra ?<input type="checkbox" class="form-control" name="bHoraExtra" id="bHoraExtra" value="1" <?=$rPublicacion{'bHoraExtra'} ? "checked" : ""?>></label>
           </div>
                                        
           <div class="form-group">    
              <label>Fecha del Evento</label>
              <input type="text" class="form-control" name="fhFechaEvento" id="fhFechaEvento" value="<?=$rPublicacion{'fhFechaEvento'} ? date('d/m/Y',strtotime($rPublicacion{'fhFechaEvento'})) : ""?>" >
           
                                        </div>
              <div class="form-group">
              <label>Hora de Servicio</label>
               <select id="tmHoraServicio" name="tmHoraServicio" class="form-control">
               <option value="">Seleccione...</option>
                    <? for($i=0;$i<sizeof($horas);$i++) { ?>
                    <option value="<?=$horas[$i][0]?>" <?=(($rPublicacion{'fhFechaEvento'} && ($horas[$i][0]==date('H:i',strtotime($rPublicacion{'fhFechaEvento'})))) ? 'selected="selected"' : '')?>><?=$horas[$i][1]?></option>
                    <? } ?>
               </select>
           </div>
                                        
           <div class="form-group">
              <label>Direcci&oacute;n</label>
              <textarea class="form-control" rows="5" style="resize:none;" name="tDireccion" id="tDireccion" maxlength="250"><?=base64_decode(utf8_decode($rPublicacion{'tDireccion'}))?></textarea>
           </div>
           <div class="form-group">
              <label>Observaciones</label>
              <textarea class="form-control" rows="5" style="resize:none;" name="tObservaciones" id="tObservaciones"><?=base64_decode(utf8_decode($rPublicacion{'tObservaciones'}))?></textarea>
           </div>
           
                                        <!--campos-->
                                    </div>
                                </div>
                                <div class="col-lg-12" id="cot2" >
                                
                                    
                               
                                    <div class="card col-lg-12" style="padding-top:20px; padding-bottom:20px;">
                                        <table class="table table-hover" id="paquetes" width="100%">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>O.T.</th>
												<th width="70%">Paquete</th>
                                                <th width="20%">Cantidad</th>
                                                <th width="5%">Importe</th>
                                            </tr>
                                        </thead>
                                        <tbody>
											<?
                                            $i = 0;
											$select = "	SELECT DISTINCT
															cs.tNombre,
                                                            cs.dPrecioVenta,
                                                            rep.eCodServicio,
                                                            rep.eCantidad,
                                                            rep.eCodTipo,
                                                            rep.dMonto,
                                                            rep.bSuma
                                                        FROM CatServicios cs
                                                        INNER JOIN RelEventosPaquetes rep ON rep.eCodServicio = cs.eCodServicio AND rep.eCodTipo = 1
                                                        WHERE rep.eCodEvento = ".$_GET['v1'];
											$rsProductos = mysql_query($select);
                                            
											while($rProducto = mysql_fetch_array($rsProductos))
											{
												?>
											<tr id="paq<?=$i?>">
                                                <td><i class="far fa-trash-alt" onclick="deleteRow('paq<?=$i?>','paquetes')"></i></td>
                                                <td>
                                                    <input type="checkbox" id="paquete<?=$i;?>-bSuma" name="paquete[<?=$i;?>][bSuma]" value="1" <?=(($rProducto{'bSuma'}==1) ? 'checked' : '')?> onclick="calcular();">
                                                </td>
                                                <td><input type="text" name="tPaquete<?=$i?>" id="tPaquete<?=$i;?>" class="form-control" onkeypress="agregarPaquete(<?=$i;?>)" onkeyup="agregarPaquete(<?=$i;?>)" value="<?=$rProducto{'tNombre'}?>" onblur="validarPaquete(<?=$i;?>)"></td>
                                                <td>
                                                <input type="hidden" name="paquete[<?=$i;?>][eCodServicio]" id="paquete<?=$i;?>-eCodServicio" value="<?=$rProducto{'eCodServicio'}?>">
                                                <input type="hidden" name="paquete[<?=$i;?>][dImporte]" id="paquete<?=$i;?>-dImporte" value="<?=$rProducto{'dPrecioVenta'}?>">
                                                <input type="text" name="paquete[<?=$i;?>][ePiezas]" id="paquete<?=$i;?>-ePiezas" value="<?=$rProducto{'eCantidad'}?>" class="form-control" onblur="validarPaquete(<?=$i;?>)">
                                                <input type="hidden" name="paquete[<?=$i;?>][eMaxPiezas]" id="paquete<?=$i;?>-eMaxPiezas" value="<?=calcularPaquete($rProducto{'eCodServicio'},$rPublicacion{'fhFechaEvento'});?>" onkeyup="validarPiezas('paquete<?=$i;?>');">
                                                </td>
                                                <td>
                                                <input type="text" name="paquete[<?=$i;?>][dMonto]" id="paquete<?=$i;?>-dMonto" value="<?=number_format($rProducto{'dMonto'},2)?>" readonly >
                                                </td>
                                            </tr>
											<?
											$i++;
											}
                                            ?>
                                            <tr id="paq<?=$i?>">
                                                <td><i class="far fa-trash-alt" onclick="deleteRow('paq<?=$i?>','paquetes')"></i></td>
                                                <td>
                                                    <input type="checkbox" id="paquete<?=$i;?>-bSuma" name="paquete[<?=$i;?>][bSuma]" value="1" <?=(($rProducto{'bSuma'}==1) ? 'checked' : '')?> onclick="calcular();">
                                                </td>
                                                <td><input type="text" name="tPaquete<?=$i?>" id="tPaquete<?=$i;?>" class="form-control" onkeypress="agregarPaquete(<?=$i;?>)" onkeyup="agregarPaquete(<?=$i;?>)" value="<?=$rProducto{'tNombre'}?>" onblur="validarPaquete(<?=$i;?>)"></td>
                                                <td>
                                                <input type="hidden" name="paquete[<?=$i;?>][eCodServicio]" id="paquete<?=$i;?>-eCodServicio" value="<?=$rProducto{'eCodServicio'}?>">
                                                <input type="hidden" name="paquete[<?=$i;?>][dImporte]" id="paquete<?=$i;?>-dImporte" value="<?=$rProducto{'dPrecioVenta'}?>">
                                                <input type="text" name="paquete[<?=$i;?>][ePiezas]" id="paquete<?=$i;?>-ePiezas" value="<?=$rProducto{'eCantidad'}?>" class="form-control" onblur="validarPaquete(<?=$i;?>)" onkeyup="validarPiezas('paquete<?=$i;?>');">
                                                <input type="hidden" name="paquete[<?=$i;?>][eMaxPiezas]" id="paquete<?=$i;?>-eMaxPiezas" value="<?=calcularPaquete($rProducto{'eCodServicio'},$rPublicacion{'fhFechaEvento'});?>">
                                                </td>
                                                <td>
                                                <input type="text" name="paquete[<?=$i;?>][dMonto]" id="paquete<?=$i;?>-dMonto" readonly>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table> 
                                        
                                        <!-- separador -->
                                        <div class="clearfix" style="padding:10px;"><img src="/images/separador.jpg" class="img-responsive" style="width:100%;"></div>
                                        <!-- separador -->
                                        
                                        <table class="table table-hover" id="invs" width="100%">
                          /*

 Copyright (C) Federico Zivolo 2018

 Distributed under the MIT License (license terms are at http://opensource.org/licenses/MIT).

 */(function(e,t){'object'==typeof exports&&'undefined'!=typeof module?module.exports=t():'function'==typeof define&&define.amd?define(t):e.Popper=t()})(this,function(){'use strict';function e(e){return e&&'[object Function]'==={}.toString.call(e)}function t(e,t){if(1!==e.nodeType)return[];var o=getComputedStyle(e,null);return t?o[t]:o}function o(e){return'HTML'===e.nodeName?e:e.parentNode||e.host}function n(e){if(!e)return document.body;switch(e.nodeName){case'HTML':case'BODY':return e.ownerDocument.body;case'#document':return e.body;}var i=t(e),r=i.overflow,p=i.overflowX,s=i.overflowY;return /(auto|scroll|overlay)/.test(r+s+p)?e:n(o(e))}function r(e){if(!e)return document.documentElement;for(var o=ie(10)?document.body:null,n=e.offsetParent;n===o&&e.nextElementSibling;)n=(e=e.nextElementSibling).offsetParent;var i=n&&n.nodeName;return i&&'BODY'!==i&&'HTML'!==i?-1!==['TD','TABLE'].indexOf(n.nodeName)&&'static'===t(n,'position')?r(n):n:e?e.ownerDocument.documentElement:document.documentElement}function p(e){var t=e.nodeName;return'BODY'!==t&&('HTML'===t||r(e.firstElementChild)===e)}function s(e){return null===e.parentNode?e:s(e.parentNode)}function d(e,t){if(!e||!e.nodeType||!t||!t.nodeType)return document.documentElement;var o=e.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_FOLLOWING,n=o?e:t,i=o?t:e,a=document.createRange();a.setStart(n,0),a.setEnd(i,0);var l=a.commonAncestorContainer;if(e!==l&&t!==l||n.contains(i))return p(l)?l:r(l);var f=s(e);return f.host?d(f.host,t):d(e,s(t).host)}function a(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'top',o='top'===t?'scrollTop':'scrollLeft',n=e.nodeName;if('BODY'===n||'HTML'===n){var i=e.ownerDocument.documentElement,r=e.ownerDocument.scrollingElement||i;return r[o]}return e[o]}function l(e,t){var o=2<arguments.length&&void 0!==arguments[2]&&arguments[2],n=a(t,'top'),i=a(t,'left'),r=o?-1:1;return e.top+=n*r,e.bottom+=n*r,e.left+=i*r,e.right+=i*r,e}function f(e,t){var o='x'===t?'Left':'Top',n='Left'==o?'Right':'Bottom';return parseFloat(e['border'+o+'Width'],10)+parseFloat(e['border'+n+'Width'],10)}function m(e,t,o,n){return Q(t['offset'+e],t['scroll'+e],o['client'+e],o['offset'+e],o['scroll'+e],ie(10)?o['offset'+e]+n['margin'+('Height'===e?'Top':'Left')]+n['margin'+('Height'===e?'Bottom':'Right')]:0)}function h(){var e=document.body,t=document.documentElement,o=ie(10)&&getComputedStyle(t);return{height:m('Height',e,t,o),width:m('Width',e,t,o)}}function c(e){return de({},e,{right:e.left+e.width,bottom:e.top+e.height})}function g(e){var o={};try{if(ie(10)){o=e.getBoundingClientRect();var n=a(e,'top'),i=a(e,'left');o.top+=n,o.left+=i,o.bottom+=n,o.right+=i}else o=e.getBoundingClientRect()}catch(t){}var r={left:o.left,top:o.top,width:o.right-o.left,height:o.bottom-o.top},p='HTML'===e.nodeName?h():{},s=p.width||e.clientWidth||r.right-r.left,d=p.height||e.clientHeight||r.bottom-r.top,l=e.offsetWidth-s,m=e.offsetHeight-d;if(l||m){var g=t(e);l-=f(g,'x'),m-=f(g,'y'),r.width-=l,r.height-=m}return c(r)}function u(e,o){var i=2<arguments.length&&void 0!==arguments[2]&&arguments[2],r=ie(10),p='HTML'===o.nodeName,s=g(e),d=g(o),a=n(e),f=t(o),m=parseFloat(f.borderTopWidth,10),h=parseFloat(f.borderLeftWidth,10);i&&'HTML'===o.nodeName&&(d.top=Q(d.top,0),d.left=Q(d.left,0));var u=c({top:s.top-d.top-m,left:s.left-d.left-h,width:s.width,height:s.height});if(u.marginTop=0,u.marginLeft=0,!r&&p){var b=parseFloat(f.marginTop,10),y=parseFloat(f.marginLeft,10);u.top-=m-b,u.bottom-=m-b,u.left-=h-y,u.right-=h-y,u.marginTop=b,u.marginLeft=y}return(r&&!i?o.contains(a):o===a&&'BODY'!==a.nodeName)&&(u=l(u,o)),u}function b(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=e.ownerDocument.documentElement,n=u(e,o),i=Q(o.clientWidth,window.innerWidth||0),r=Q(o.clientHeight,window.innerHeight||0),p=t?0:a(o),s=t?0:a(o,'left'),d={top:p-n.top+n.marginTop,left:s-n.left+n.marginLeft,width:i,height:r};return c(d)}function y(e){var n=e.nodeName;return'BODY'===n||'HTML'===n?!1:'fixed'===t(e,'position')||y(o(e))}function w(e){if(!e||!e.parentElement||ie())return document.documentElement;for(var o=e.parentElement;o&&'none'===t(o,'transform');)o=o.parentElement;return o||document.documentElement}function E(e,t,i,r){var p=4<arguments.length&&void 0!==arguments[4]&&arguments[4],s={top:0,left:0},a=p?w(e):d(e,t);if('viewport'===r)s=b(a,p);else{var l;'scrollParent'===r?(l=n(o(t)),'BODY'===l.nodeName&&(l=e.ownerDocument.documentElement)):'window'===r?l=e.ownerDocument.documentElement:l=r;var f=u(l,a,p);if('HTML'===l.nodeName&&!y(a)){var m=h(),c=m.height,g=m.width;s.top+=f.top-f.marginTop,s.bottom=c+f.top,s.left+=f.left-f.marginLeft,s.right=g+f.left}else s=f}return s.left+=i,s.top+=i,s.right-=i,s.bottom-=i,s}function v(e){var t=e.width,o=e.height;return t*o}function x(e,t,o,n,i){var r=5<arguments.length&&void 0!==arguments[5]?arguments[5]:0;if(-1===e.indexOf('auto'))return e;var p=E(o,n,r,i),s={top:{width:p.width,height:t.top-p.top},right:{width:p.right-t.right,height:p.height},bottom:{width:p.width,height:p.bottom-t.bottom},left:{width:t.left-p.left,height:p.height}},d=Object.keys(s).map(function(e){return de({key:e},s[e],{area:v(s[e])})}).sort(function(e,t){return t.area-e.area}),a=d.filter(function(e){var t=e.width,n=e.height;return t>=o.clientWidth&&n>=o.clientHeight}),l=0<a.length?a[0].key:d[0].key,f=e.split('-')[1];return l+(f?'-'+f:'')}function O(e,t,o){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,i=n?w(t):d(t,o);return u(o,i,n)}function L(e){var t=getComputedStyle(e),o=parseFloat(t.marginTop)+parseFloat(t.marginBottom),n=parseFloat(t.marginLeft)+parseFloat(t.marginRight),i={width:e.offsetWidth+n,height:e.offsetHeight+o};return i}function S(e){var t={left:'right',right:'left',bottom:'top',top:'bottom'};return e.replace(/left|right|bottom|top/g,function(e){return t[e]})}function T(e,t,o){o=o.split('-')[0];var n=L(e),i={width:n.width,height:n.height},r=-1!==['right','left'].indexOf(o),p=r?'top':'left',s=r?'left':'top',d=r?'height':'width',a=r?'width':'height';return i[p]=t[p]+t[d]/2-n[d]/2,i[s]=o===s?t[s]-n[a]:t[S(s)],i}function D(e,t){return Array.prototype.find?e.find(t):e.filter(t)[0]}function C(e,t,o){if(Array.prototype.findIndex)return e.findIndex(function(e){return e[t]===o});var n=D(e,function(e){return e[t]===o});return e.indexOf(n)}function N(t,o,n){var i=void 0===n?t:t.slice(0,C(t,'name',n));return i.forEach(function(t){t['function']&&console.warn('`modifier.function` is deprecated, use `modifier.fn`!');var n=t['function']||t.fn;t.enabled&&e(n)&&(o.offsets.popper=c(o.offsets.popper),o.offsets.reference=c(o.offsets.reference),o=n(o,t))}),o}function k(){if(!this.state.isDestroyed){var e={instance:this,styles:{},arrowStyles:{},attributes:{},flipped:!1,offsets:{}};e.offsets.reference=O(this.state,this.popper,this.reference,this.options.positionFixed),e.placement=x(this.options.placement,e.offsets.reference,this.popper,this.reference,this.options.modifiers.flip.boundariesElement,this.options.modifiers.flip.padding),e.originalPlacement=e.placement,e.positionFixed=this.options.positionFixed,e.offsets.popper=T(this.popper,e.offsets.reference,e.placement),e.offsets.popper.position=this.options.positionFixed?'fixed':'absolute',e=N(this.modifiers,e),this.state.isCreated?this.options.onUpdate(e):(this.state.isCreated=!0,this.options.onCreate(e))}}function P(e,t){return e.some(function(e){var o=e.name,n=e.enabled;return n&&o===t})}function W(e){for(var t=[!1,'ms','Webkit','Moz','O'],o=e.charAt(0).toUpperCase()+e.slice(1),n=0;n<t.length;n++){var i=t[n],r=i?''+i+o:e;if('undefined'!=typeof document.body.style[r])return r}return null}function B(){return this.state.isDestroyed=!0,P(this.modifiers,'applyStyle')&&(this.popper.removeAttribute('x-placement'),this.popper.style.position='',this.popper.style.top='',this.popper.style.left='',this.popper.style.right='',this.popper.style.bottom='',this.popper.style.willChange='',this.popper.style[W('transform')]=''),this.disableEventListeners(),this.options.removeOnDestroy&&this.popper.parentNode.removeChild(this.popper),this}function H(e){var t=e.ownerDocument;return t?t.defaultView:window}function A(e,t,o,i){var r='BODY'===e.nodeName,p=r?e.ownerDocument.defaultView:e;p.addEventListener(t,o,{passive:!0}),r||A(n(p.parentNode),t,o,i),i.push(p)}function I(e,t,o,i){o.updateBound=i,H(e).addEventListener('resize',o.updateBound,{passive:!0});var r=n(e);return A(r,'scroll',o.updateBound,o.scrollParents),o.scrollElement=r,o.eventsEnabled=!0,o}function M(){this.state.eventsEnabled||(this.state=I(this.reference,this.options,this.state,this.scheduleUpdate))}function F(e,t){return H(e).removeEventListener('resize',t.updateBound),t.scrollParents.forEach(function(e){e.removeEventListener('scroll',t.updateBound)}),t.updateBound=null,t.scrollParents=[],t.scrollElement=null,t.eventsEnabled=!1,t}function R(){this.state.eventsEnabled&&(cancelAnimationFrame(this.scheduleUpdate),this.state=F(this.reference,this.state))}function U(e){return''!==e&&!isNaN(parseFloat(e))&&isFinite(e)}function Y(e,t){Object.keys(t).forEach(function(o){var n='';-1!==['width','height','top','right','bottom','left'].indexOf(o)&&U(t[o])&&(n='px'),e.style[o]=t[o]+n})}function j(e,t){Object.keys(t).forEach(function(o){var n=t[o];!1===n?e.removeAttribute(o):e.setAttribute(o,t[o])})}function q(e,t,o){var n=D(e,function(e){var o=e.name;return o===t}),i=!!n&&e.some(function(e){return e.name===o&&e.enabled&&e.order<n.order});if(!i){var r='`'+t+'`';console.warn('`'+o+'`'+' modifier is required by '+r+' modifier in order to work, be sure to include it before '+r+'!')}return i}function K(e){return'end'===e?'start':'start'===e?'end':e}function V(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1],o=le.indexOf(e),n=le.slice(o+1).concat(le.slice(0,o));return t?n.reverse():n}function z(e,t,o,n){var i=e.match(/((?:\-|\+)?\d*\.?\d*)(.*)/),r=+i[1],p=i[2];if(!r)return e;if(0===p.indexOf('%')){var s;switch(p){case'%p':s=o;break;case'%':case'%r':default:s=n;}var d=c(s);return d[t]/100*r}if('vh'===p||'vw'===p){var a;return a='vh'===p?Q(document.documentElement.clientHeight,window.innerHeight||0):Q(document.documentElement.clientWidth,window.innerWidth||0),a/100*r}return r}function G(e,t,o,n){var i=[0,0],r=-1!==['right','left'].indexOf(n),p=e.split(/(\+|\-)/).map(function(e){return e.trim()}),s=p.indexOf(D(p,function(e){return-1!==e.search(/,|\s/)}));p[s]&&-1===p[s].indexOf(',')&&console.warn('Offsets separated by white space(s) are deprecated, use a comma (,) instead.');var d=/\s*,\s*|\s+/,a=-1===s?[p]:[p.slice(0,s).concat([p[s].split(d)[0]]),[p[s].split(d)[1]].concat(p.slice(s+1))];return a=a.map(function(e,n){var i=(1===n?!r:r)?'height':'width',p=!1;return e.reduce(function(e,t){return''===e[e.length-1]&&-1!==['+','-'].indexOf(t)?(e[e.length-1]=t,p=!0,e):p?(e[e.length-1]+=t,p=!1,e):e.concat(t)},[]).map(function(e){return z(e,i,t,o)})}),a.forEach(function(e,t){e.forEach(function(o,n){U(o)&&(i[t]+=o*('-'===e[n-1]?-1:1))})}),i}function _(e,t){var o,n=t.offset,i=e.placement,r=e.offsets,p=r.popper,s=r.reference,d=i.split('-')[0];return o=U(+n)?[+n,0]:G(n,p,s,d),'left'===d?(p.top+=o[0],p.left-=o[1]):'right'===d?(p.top+=o[0],p.left+=o[1]):'top'===d?(p.left+=o[0],p.top-=o[1]):'bottom'===d&&(p.left+=o[0],p.top+=o[1]),e.popper=p,e}for(var X=Math.min,J=Math.floor,Q=Math.max,Z='undefined'!=typeof window&&'undefined'!=typeof document,$=['Edge','Trident','Firefox'],ee=0,te=0;te<$.length;te+=1)if(Z&&0<=navigator.userAgent.indexOf($[te])){ee=1;break}var i=Z&&window.Promise,oe=i?function(e){var t=!1;return function(){t||(t=!0,window.Promise.resolve().then(function(){t=!1,e()}))}}:function(e){var t=!1;return function(){t||(t=!0,setTimeout(function(){t=!1,e()},ee))}},ne={},ie=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:'all';return(e=e.toString(),ne.hasOwnProperty(e))?ne[e]:('11'===e?ne[e]=-1!==navigator.userAgent.indexOf('Trident'):'10'===e?ne[e]=-1!==navigator.appVersion.indexOf('MSIE 10'):'all'===e?ne[e]=-1!==navigator.userAgent.indexOf('Trident')||-1!==navigator.userAgent.indexOf('MSIE'):void 0,ne.all=ne.all||Object.keys(ne).some(function(e){return ne[e]}),ne[e])},re=function(e,t){if(!(e instanceof t))throw new TypeError('Cannot call a class as a function')},pe=function(){function e(e,t){for(var o,n=0;n<t.length;n++)o=t[n],o.enumerable=o.enumerable||!1,o.configurable=!0,'value'in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}return function(t,o,n){return o&&e(t.prototype,o),n&&e(t,n),t}}(),se=function(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e},de=Object.assign||function(e){for(var t,o=1;o<arguments.length;o++)for(var n in t=arguments[o],t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},ae=['auto-start','auto','auto-end','top-start','top','top-end','right-start','right','right-end','bottom-end','bottom','bottom-start','left-end','left','left-start'],le=ae.slice(3),fe={FLIP:'flip',CLOCKWISE:'clockwise',COUNTERCLOCKWISE:'counterclockwise'},me=function(){function t(o,n){var i=this,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};re(this,t),this.scheduleUpdate=function(){return requestAnimationFrame(i.update)},this.update=oe(this.update.bind(this)),this.options=de({},t.Defaults,r),this.state={isDestroyed:!1,isCreated:!1,scrollParents:[]},this.reference=o&&o.jquery?o[0]:o,this.popper=n&&n.jquery?n[0]:n,this.options.modifiers={},Object.keys(de({},t.Defaults.modifiers,r.modifiers)).forEach(function(e){i.options.modifiers[e]=de({},t.Defaults.modifiers[e]||{},r.modifiers?r.modifiers[e]:{})}),this.modifiers=Object.keys(this.options.modifiers).map(function(e){return de({name:e},i.options.modifiers[e])}).sort(function(e,t){return e.order-t.order}              <thead>
                                            <tr>
                                                <th></th>
                                                <th>O.T.</th>
												<th width="70%">Producto</th>
                                                <th width="20%">Cantidad</th>
                                                <th width="5%">Importe</th>
                                            </tr>
                                        </thead>
                                        <tbody>
											<?
                                            $i = 0;
											$select = "	SELECT DISTINCT
															cs.tNombre,
                                                            cs.dPrecioVenta,
                                                            rep.eCodServicio,
                                                            rep.eCantidad,
                                                            rep.eCodTipo,
                                                            rep.dMonto,
                                                            rep.bSuma
                                                        FROM CatInventario cs
                                                        INNER JOIN RelEventosPaquetes rep ON rep.eCodServicio = cs.eCodInventario and rep.eCodTipo = 2
                                                        WHERE rep.eCodEvento = ".$_GET['v1'];
											$rsProductos = mysql_query($select);
                                            
											while($rProducto = mysql_fetch_array($rsProductos))
											{
												?>
											<tr id="inv<?=$i?>">
                                                <td><i class="far fa-trash-alt" onclick="deleteRow('inv<?=$i?>','invs')"></i></td>
                                                <td>
                                                    <input type="checkbox" id="inventario<?=$i;?>-bSuma" name="inventario[<?=$i;?>][bSuma]" value="1" <?=(($rProducto{'bSuma'}==1) ? 'checked' : '')?> onclick="calcular();">
                                                </td>
                                                <td><input type="text" name="tInventario<?=$i?>" id="tInventario<?=$i;?>" class="form-control" onkeypress="agregarInventario(<?=$i;?>)" onkeyup="agregarInventario(<?=$i;?>)" value="<?=$rProducto{'tNombre'}?>" onblur="validarInventario(<?=$i;?>)"></td>
                                                <td>
                                                <input type="hidden" name="inventario[<?=$i;?>][eCodInventario]" id="inventario<?=$i;?>-eCodInventario" value="<?=$rProducto{'eCodServicio'}?>">
                                                <input type="hidden" name="inventario[<?=$i;?>][dImporte]" id="inventario<?=$i;?>-dImporte" value="<?=$rProducto{'dPrecioVenta'}?>">
                                                <input type="text" name="inventario[<?=$i;?>][ePiezas]" id="inventario<?=$i;?>-ePiezas" value="<?=$rProducto{'eCantidad'}?>" class="form-control">
                                                <input type="hidden" name="inventario[<?=$i;?>][eMaxPiezas]" id="inventario<?=$i;?>-eMaxPiezas" value="<?=calcularInventario($rProducto{'eCodServicio'},$rPublicacion{'fhFechaEvento'});?>" onblur="validarInventario(<?=$i;?>)" onkeyup="validarPiezas('inventario<?=$i;?>');">
                                                </td>
                                                <td>
                                                <input type="text" name="inventario[<?=$i;?>][dMonto]" id="inventario<?=$i;?>-dMonto" value="<?=number_format($rProducto{'dMonto'},2)?>" readonly>
                                                </td>
                                            </tr>
											<?
											$i++;
											}
                                            ?>
                                            <tr id="inv<?=$i?>">
                                                <td><i class="far fa-trash-alt" onclick="deleteRow('inv<?=$i?>','invs')"></i></td>
                                                <td>
                                                    <input type="checkbox" id="inventario<?=$i;?>-bSuma" name="inventario[<?=$i;?>][bSuma]" value="1" onclick="calcular();">
                                                </td>
                                                <td><input type="text" name="tInventario<?=$i?>" id="tInventario<?=$i;?>" class="form-control" onkeypress="agregarInventario(<?=$i;?>)" onkeyup="agregarInventario(<?=$i;?>)" onblur="validarInventario(<?=$i;?>)"></td>
                                                <td>
                                                <input type="hidden" name="inventario[<?=$i;?>][eCodInventario]" id="inventario<?=$i;?>-eCodInventario">
                                                <input type="hidden" name="inventario[<?=$i;?>][dImporte]" id="inventario<?=$i;?>-dImporte">
                                                <input type="text" name="inventario[<?=$i;?>][ePiezas]" id="inventario<?=$i;?>-ePiezas" class="form-control" onblur="validarInventario(<?=$i;?>)" onkeyup="validarPiezas('inventario<?=$i;?>');">
                                                <input type="hidden" name="inventario[<?=$i;?>][eMaxPiezas]" id="inventario<?=$i;?>-eMaxPiezas">
                                                </td>
                                                <td>
                                                <input type="text" name="inventario[<?=$i;?>][dMonto]" id="inventario<?=$i;?>-dMonto" readonly>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table> 
                                    
                                    <!-- separador -->
                                        <div class="clearfix" style="padding:10px;"><img src="/images/separador.jpg" class="img-responsive" style="width:100%;"></div>
                                        <!-- separador -->
                                        
                                    <!--Extras-->
                                    
                                        <table class="table table-hover" id="extras" width="100%">
                                        <thead>
                                            <tr>
                                                <th></th>
                                                <th>O.T.</th>
												<th width="88%">Extra</th>
                                                <th width="5%">Precio</th>
                                            </tr>
                                        </thead>
                                        <tbody>
											<?
                                            $i = 0;
											$select = "	SELECT *
                                                        FROM RelEventosExtras
                                                        WHERE eCodEvento = ".$_GET['v1'];
											$rsPublicaciones = mysql_query($select);
                                            
											while($rPublicacion = mysql_fetch_array($rsPublicaciones))
											{
												?>
											<tr id="ext<?=$i?>">
                                                <td><i class="far fa-trash-alt" onclick="deleteRow('ext<?=$i?>')"></i></td>
                                                <td>
                                                    <input type="checkbox" id="extra<?=$i;?>-bSuma" name="extra[<?=$i;?>][bSuma]" value="1" <?=(($rPublicacion{'bSuma'}==1) ? 'checked' : '')?> onclick="calcular();">
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" id="extra<?=$i;?>-tDescripcion" name="extra[<?=$i;?>][tDescripcion]" value="<?=$rPublicacion{'tDescripcion'}?>" onchange="validarExtra(<?=$i;?>)">
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" id="extra<?=$i;?>-dImporte" name="extra[<?=$i;?>][dImporte]" value="<?=$rPublicacion{'dImporte'}?>" onchange="validarExtra(<?=$i;?>)">
                                                </td>
                                            </tr>
											<?
											$i++;
											} ?>
                                            <tr id="ext<?=$i?>">
                                                <td><i class="far fa-trash-alt" onclick="deleteRow('ext<?=$i?>')"></i></td>
                                                <td>
                                                    <input type="checkbox" id="extra<?=$i;?>-bSuma" name="extra[<?=$i;?>][bSuma]" value="1" onclick="calcular();">
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" id="extra<?=$i;?>-tDescripcion" name="extra[<?=$i;?>][tDescripcion]" value="<?=$rPublicacion{'tNombre'}?>" onchange="validarExtra(<?=$i;?>)">
                                                </td>
                                                <td>
                                                    <input type="text" class="form-control" id="extra<?=$i;?>-dImporte" name="extra[<?=$i;?>][dImporte]" value="<?=$rPublicacion{'dImporte'}?>" onchange="validarExtra(<?=$i;?>)">
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>    
                                    </div>
                                    <!--Extras-->
                                    
      
                                    </div>
                                </div>
                                
                                <div class="col-lg-12" id="cot3" >
                                
                                    <div class="card-body card-block">
                                    <table class="table table-borderless ">
                                        <thead>
                                            <tr>
                                                
                                                <td align="right" width="85%">
                                                    
                                                    <input type="hidden" id="totEvento" value="0">
                                                </td>
                                                <td id="totalVenta" align="right">
                                                    
                                                </td>
                                            </tr>
                                            <tr id="brIVA" hidden>
                                                
                                                <td align="right" width="85%">
                                                    
                                                    
                                                </td>
                                                <td id="totalIVA" align="right">
                                                    
                                                </td>
                                            </tr>
                                            <tr id="brTotal" hidden>
                                                
                                                <td align="right" width="85%">
                                                    
                                                   
                                                </td>
                                                <td id="totalTotal" align="right">
                                                    
                                                </td>
                                            </tr>
                                            
                                        </thead>
                                    </table>
      
                                    </div>
                                </div>
                                
                            </div>
        <input type="hidden" name="eFilas" id="eFilas" value="<?=$i?>">
    </form>
    </div>
                        </div>



<script>
    
    //autocompletes
    function agregarInventario(indice)
        {
            var tInventario = document.getElementById('tInventario'+indice),
                eCodInventario = document.getElementById('inventario'+indice+'-eCodInventario'),
                eMaxPiezas = document.getElementById('inventario'+indice+'-eMaxPiezas'),
                dImporte = document.getElementById('inventario'+indice+'-dImporte');
            
            if(tInventario.value=="" || !tInventario.value)
                {
                    eCodInventario.value="";
                    eMaxPiezas.value="";
                    dImporte.value="";
                }
            
            var fhFecha = document.getElementById('fhFechaEvento');
            
             $( function() {
  
        $( "#tInventario"+indice ).autocomplete({
            source: function( request, response ) {
                
                $.ajax({
                    url: "/que/json-inventario.php",
                    type: 'get',
                    dataType: "json",
                    data: {
                        search: request.term,
                        fhfecha: ((fhFecha && fhFecha.value) ? fhFecha.value : "")
                    },
                    success: function( data ) {
                        response( data );
                    }
                });
            },
            select: function (event, ui) {
                $('#tInventario'+indice).val(ui.item.label);
                $('#inventario'+indice+'-eCodInventario').val(ui.item.value); 
                $('#inventario'+indice+'-eMaxPiezas').val(ui.item.maxpiezas);
                $('#inventario'+indice+'-dImporte').val(ui.item.precioventa);
                return false;
                
            }
        });

       
        }); 
        }
    
    function agregarPaquete(indice)
        {
            var tPaquete = document.getElementById('tPaquete'+indice),
                eCodServicio = document.getElementById('paquete'+indice+'-eCodServicio'),
                eMaxPiezas = document.getElementById('paquete'+indice+'-eMaxPiezas'),
                dImporte = document.getElementById('paquete'+indice+'-dImporte');
            
            if(tPaquete.value=="" || !tPaquete.value)
                {
                    eCodServicio.value="";
                    eMaxPiezas.value="";
                    dImporte.value="";
                }
            
            var fhFecha = document.getElementById('fhFechaEvento');
            
             $( function() {
  
        $( "#tPaquete"+indice ).autocomplete({
            source: function( request, response ) {
                
                $.ajax({
                    url: "/que/json-paquetes.php",
                    type: 'get',
                    dataType: "json",
                    data: {
                        search: request.term,
                        fhfecha: ((fhFecha && fhFecha.value) ? fhFecha.value : "")
                    },
                    success: function( data ) {
                        response( data );
                    }
                });
            },
            select: function (event, ui) {
                $('#tPaquete'+indice).val(ui.item.label);
                $('#paquete'+indice+'-eCodServicio').val(ui.item.value); 
                $('#paquete'+indice+'-eMaxPiezas').val(ui.item.maxpiezas);
                $('#paquete'+indice+'-dImporte').val(ui.item.precioventa);
                return false;
                
            }
        });

       
        }); 
        }

    
    function calcular()
    {
        var venta = 0;
        var cmbExtras = document.querySelectorAll("tr[id^=ext]");
        var cmbPaq = document.querySelectorAll("tr[id^=paq]");
        var cmbInv = document.querySelectorAll("tr[id^=inv]");
        var iva;
        var total;
        
        var bIVA = document.getElementById('bIVA');
        
        var leyenda="";
        leyenda = (bIVA.checked==true) ? "Subtotal" : "Total";
        
        var ocultar = (!bIVA.checked) ? true : false;
        
        cmbPaq.forEach(function(nodo){
            
            var idx = nodo.id.replace("paq","");
            
            calcularTotalPaquete(idx);
            
            var dImporte = document.getElementById('paquete'+idx+'-dMonto'),
                bSuma    =  document.getElementById('paquete'+idx+'-bSuma');
            
            dImporte.style.display = (bSuma.checked) ? 'none' : 'inline';
            
            venta = parseInt(venta) + parseInt((dImporte.value && bSuma.checked==false) ? dImporte.value : 0);
            iva = (bIVA.checked) ? venta*0.16 : 0;
            total = (bIVA.checked) ? venta*1.16 : venta;
        });
        cmbInv.forEach(function(nodo){
            
            var idx = nodo.id.replace("inv","");
            
            calcularTotalInventario(idx);
            
            var dImporte = document.getElementById('inventario'+idx+'-dMonto'),
                bSuma    =  document.getElementById('inventario'+idx+'-bSuma');
            
            dImporte.style.display = (bSuma.checked) ? 'none' : 'inline';
            
            venta = parseInt(venta) + parseInt((dImporte.value && bSuma.checked==false) ? dImporte.value : 0);
            iva = (bIVA.checked) ? venta*0.16 : 0;
            total = (bIVA.checked) ? venta*1.16 : venta;
        });
        cmbExtras.forEach(function(nodo){
            
            var idx = nodo.id.replace("ext","");
            
            var dImporte = document.getElementById('extra'+idx+'-dImporte'),
                bSuma    =  document.getElementById('extra'+idx+'-bSuma');
            
            
            venta = parseInt(venta) + parseInt((dImporte.value && bSuma.checked==false) ? dImporte.value : 0);
            iva = (bIVA.checked) ? venta*0.16 : 0;
            total = (bIVA.checked) ? venta*1.16 : venta;
        });
        
        
        
        document.getElementById('totalVenta').innerHTML = leyenda+" $"+venta.toFixed(2);
        document.getElementById('totalIVA').innerHTML = "I.V.A. $"+iva.toFixed(2);
        document.getElementById('totalTotal').innerHTML = "Total $"+total.toFixed(2);
        document.getElementById('brIVA').hidden = ocultar;
        document.getElementById('brTotal').hidden = ocultar;
    }
    
    $(document).ready(function() {
              $('#fhFechaEvento').datepicker({
                  locale:'es',
                  dateFormat: "dd/mm/yy"
              });
          });
    
    calcular();
    

		</script>